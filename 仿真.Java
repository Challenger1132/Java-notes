/*
1、关于线性拟合
仿真注意点
就是进行线性拟合完毕，还有可能出现相位折叠，所以最好UNwrap一下？
(情况之一是，得到的相位矩阵没有相位的折叠，但是进行angle函数之后，相位反而出现了折叠)
得到相位矩阵phase_matrix，与用phase_matrix重新构建CSI数据再求相位矩阵，应该是一样的

2、关于Pmusic矩阵反转的问题，得到伪谱矩阵Pmusic
	没有必要这样再求一个log，再求绝对值，log对于大值会变小，小值可能为负值
关于图像不一致问题，图像推导一致，但是实际绘制不一致，是因为矩阵的共轭转置问题、非共轭转置问题未处理好
3、当绘制图像呈现圆圈的时候，数据可能是complex类型，是实部和虚部造成的

理解CSI
	每个子载波都L条多径，每个多径有N个子载波，因此会有L*N的复衰减矩阵
	M个天线，L条多径形成的M*L的导向矩阵对所有的子载波都是一样的
	也就是说，每个单一频率的子载波，都对应M*L维的一个导向矩阵
	当多个子载波经过L条多径形成一个L*N的复衰减矩阵的时候
	导向矩阵乘以L*N复衰减矩阵就是就收到的CSI数据

	不同多径的的入射角度不同，一条路径包含了多个频率成分，一个路径在某个天线（由于入射角度和天线之间的距离）
	引入的相位差对该路径的所有子载波都是一样的，一条路径的所有子载波的tof一样，
	由于子载波不同频率而引入的相位差是不同的（相同的天线相位，不同的子载波相位）
	同一频率的不同多径，由于多径的入射角度不同，在天线处的相位是不同的，在子载波处的相位是一样的
	OFDM原始信号就是多个不同的频率成分的叠加，传播过程中形成多径，每个路径都是一束不同频率的信号。

	对于某个特定的路径，在不同天线，不同子载波处的相位相位形式刚好是CSI测量矩阵的形式,参见Sotifi Fig3(a)
	而纵向看CSI矩阵就是K条多径的叠加，因此CSI测量矩阵可以看成多层(K)的数据的叠加，第K条路径是第K层
	每一层代表某个路径在不同天线，不同子载波处的响应
	某个特定路径到来时，对不同频率的子载波进行剥离，由于tau相同，在不同的子载波处的相位是不一样的(子载波间隔造成)
	由于不同位置的天线，在不同天线处的相位也不相同(多少倍天线之间的距离)，而这就是CSI测量矩阵的一层
	K条路径，K层叠加，形成的是CSI测量矩阵，因此每一个CSI测量值都是在某个天线，某个子载波下，K条路径的叠加
	对于某一层，不同的CSI测量值包含的天线相位和子载波相位是不同的，
	CSI测量值是多层的叠加，是一个相位的混合值，不同路径到达角度不同，因此引起的天线相位不同，
	飞行时间不同，因此特定子载波处引入的子载波相位也不相同
	因此一个CSI测量值，可以理解为，在某个天线下，某个子载波处，
	K条多径(K个天线相位，K个子载波相位，原因是K条多径，天线处的K个不同的角度，子载波处K个飞行时间)的叠加
	CSI测量矩阵是导矢与复衰减的结合(导向矩阵在CSI测量矩阵维度的理解)

	CSI导向矩阵的理解形式M*L
	CSI天线方向，子载波方向的理解形式
	CSI测量矩阵分层理解形式

	tof的改变仅仅影响的是不同子载波(列)之间的相位(相位差)，但各个子载波对于不同天线相对相位信息还是保留的

	K条多径K个不同的入射角，等价于在时间上展开的K次天线测量值(K个入射角K个多径不可能同时到达天线)
	而在某个特定的天线上，是没有天线相位的，仅仅是K次不同的测量值，而在一个天线上，特定子载波，CSI的值
	仅仅是特定频率下K次不同时间上的测量的叠加，因此说反映的是多径效应
	单一天线不涉及角度引入相位差，单天线，不同信号入射角度，仅能表示不同次的天线测量

	为什么进行相位拟合改变了TOF的值，不影响角度的估计？
		某条路径以某个角度入射天线，所有子载波也以相同的角度入射天线，
		将一条路径信号不同频率进行分离，不同频率在不同的天线之间会造成相位差(频率1会在不通过天线之间形成相位差
		频率2在不同的天线处也会形成相位差)，由于相同的TOF，不同频率之前也会形成相位差，进行线性拟合，改变了TOF的值
		改变的仅仅是不同频率之前的相位(差),不同列数据的相位，但是每一列天线测量值的相对相位信息还是保留的
		
	如何理解特定子载波下，天线测量值的相对相位信息是保留的？
		在特定的子载波下，当天线之间的距离入射角度等参数确定，信号到达不同的天线的时间也就确定了
		进而由于天线位置入射角度引入的相位差也就确定了，和实际的信号飞行时间没有关系，是某个特定子载波
		在原来tof的基础上先到达天线，再飞行相应的时间到达间隔相等的不同的天线，但是无论如何改变原来的tof值
		由于天线之间距离和入射角度对信号造成的飞行时间是一样的
		信号从信源开始，到达不同天线的时间不同，因此不同天线的相位记录不同
		因此在特定子载波下，信号到达天线的飞行时间有两部分组成，T{信号发端到收端} + T{(M-1)d*sin(θ)}
		正是这个时间产生了信号的相位，但是在不同子载波下，信号频率不同，相位差还是有细微差别的，因为随着
		子载波编号变大，频率也越大，相位差也越大(所有子载波下的飞行的时间模式完全一样)
		不同子载波之间在天线之间引入的相位差别，2*π*(fi - fj)*τ
		同一子载波不同天线之间引入的相位差别， 2*π*f*(d*sin(θ)/c)
		
	一条多径的所有子载波到达天线的时间τ都是一样的
	一个子载波下的K条多径，其实是一个天线时间上的K次测量，K次测量的叠加就是一个CSI的值(特定子载波特定频率下的值)
		
	信号经过不同的天线，在天线处的衰减是一样的，天线的测量值仅仅区别于相位累积

	一条路径角度θ1，在不同频率子载波上分离，第二条路径角度θ2，也在不同频率子载波上分离，...
	对于同一个天线，是不同时刻的测量，反映的是多径效应，不同的天线之间(每个频率下都)形成相位差

	对于一个天线，不同子载波相位是线性的，TOF是斜率

	天线位置，信号入射角度，不产生相位
		其实不同的天线位置形成的相位是个伪命题，不同的天线位置之间只有相位差，不产生相位，本质原因还是因为天线位置
		不同而使某个频率的电磁波到达天线时候TOF不同造成的相位差，而入射角度改变的仅仅是到达不同天线时
		电磁波走过的路径，因此天线位置，信号入射角度，不产生相位
		不同的子载波情况是一样的，只是不同子载波频率不同也有相位差，不同子载波仅仅是各自频率不一样相位不同
		不影响各自由于天线位置引入的相位差，相位φ = 2π*f*t 因此相位只与信号频率和信号飞行时间有关系
		对于CSI测量矩阵，不同列是由于不同子载波频率形成的相位差(tof相同)，不同行是因为信号不同的tof(频率相同)

	CSI的值仅仅是特定频率下(K条多径)K次不同时间上的测量值的的叠加

	
对于CSI矩阵纵向是不同的天线相位，横向是不同的子载波相位，深向是不同的多径

一个信号源，经过多径，等效为多个信号源，因此一定要找到LOS

为什么天线方向，不同频率子载波引入的相位差是很小的，而子载波方向引入的相位差是可观的？
相位都是2*pi*f*t,而t都是距离除以速度，天线方向是由于天线之间的距离引入的时间
子载波方向直接给出了信号的传播时间，由于收发端之间的距离不同，本质上还是连个不同的距离

不同阵元(包含虚拟阵元)处的测量，都可以写成相同导向矢量的线性组合

M个天线，L条多径的M*L的导矢，在某个特定频率的子载波下面(L*1)，会形成CSI测量矩阵一列
N个子载波(L*N)，形成M*N的CSI测量矩阵

线性拟合部分可以使用补偿时间的方式进行替换
用CIR提取LOS能量	线性拟合、线性变换消除STO影响，然后提取LOS能量
					补偿一定的时间得到CIR，提取LOS能量(还可以防止过拟合、过拟合、过拟合、过拟合、过拟合、过拟合、过拟合、过拟合、过拟合)
					CIR方差大小进行提取LOS能量
用CSI计算能量		用奇数子载波计算LOS能量，剔除偶数子载波
					CSI变化为CIR，滤除NLOS以及噪声，然后再进行能量计算
					
对于每个数据包，在进行AOA以及TOF估计之前，必须移除随机的采样时间偏移带来的影响，也就是说消除STO带来的时延误差
就是对三天线上的所有路径的CSI数据的UNwrap phase减去线性拟合得到的相位，本质就是减去STO带来的相位

“STO PDD造成的时延对所有路径都是相同的”，使得绝对tof获取不可能，但是可以利用多个路径的相对tof值
STO PDD造成的时延对所有路径都是相同的，(对所有路径都增加了相同的一个时延值，
且这个时延值要远远大于收发端之间距离传输所需的时间tof)
并且STO、PDD带来的时延是随机的，对不同的包是不一样的，因此STO、PDD带来的时延使得获得真正的tof变得不可能，
也就是说无法获取真正的tof值，但是正是STO PDD造成的时延对所有路径都是相同的，所以不同路径的相对tof还是可以利用的
since the ToFs of all the paths will have the same delay added to them due to STO, we can still use the
path with the lowest ToF to identify which path traveled the shortest relative distance.

PDD、STO >> tof >> t = d*sinθ / c
1> PDD、STO是时延误差，等价于频域的线性相位旋转，对CSI数据造成线性相位误差
2> tof是由于收发端之间距离造成的时延，是飞行时间，获取tof可以用来测距
3> t是相邻天线之间距离引入的时延，正是由于这个t，造成信号到达不同天线之间的相位差，因此这个t也保留了信号的入射角度信息
	t被破坏，信号角度信息也就不复存在了。。。。。
4> 线性拟合的本质和目的就是对于不同的数据包，消除这个随数据包随机变化的PDD、STO，
对所有有路径都剔除PDD、STO带来的时延误差，是的所有路径的相对tof可以利用，进而用于LOS估计
线性拟合得到一个时延值tau
最理想的情况是得到的tof最接近真实的tof，这样可以直接使用tof进行距离估计

论文中是通过linear fit来消除这个PDD、STO的值的，消除精度由最小二乘估计来保证，但是不会造成过拟合问题？
如果直接在对CSI相位进行时间补偿(几百纳秒的时间)，相当于将功率时延谱向左移动，是不是也可以实现消除PDD、STO？
PS.如果PDD、STO是常量，或者服从某种分布，那么就可以得到精确的tof值

时延模型
	τ = T_error + T_tof + T_antenna
	T_error 代表由PDD、STO 带来的时延
	T_tof 信号在收发端之间的传播时延，真正的飞行时间
	T_antenna 代表由于天线之间距离引入的时间 T_antenna = (n-1)d*sinθ / c. 
	角度的信息保留在这里，正是由于有T_antenna才有了角度信息
	当 τ_fit <= T_error 角度信息被保留
	当 τ_fit <= T_error + T_tof 	角度信息被保留
	当 τ_fit 介于 T_error + T_tof 以及 T_error + T_tof + T_antenna之间角度信息被破坏
	当τ_fit  >= T_error + T_tof + T_antenna，角度信息也被破坏

每个包单独拟合？
所有数据包都减去同一个时延值带来的相位误差，其实也是有道理的，只要不破坏角度信息，且
所有包的PDD、STO虽然是随机的，但是大致都为同号，都减去一个相同的拟合时延值也是可以的

在一个特定的子载波下，STO对所有天线造成的相位误差是相同的，对同一张WiFi网卡，所有路径都是时间同步的
The additional phase induced by STO is the same across antennas for a particular subcarrier 
as all the receiver chains of the same WiFi card are time synchronized

两种平滑方式
1、对3*30的矩阵重新构造，(相当于去相干)，得到30*32的矩阵x，求协方差矩阵
R = x*x';30*30，导向矢量要和协方差矩阵维度一致，也是30，对30*30的协方差矩阵分解，
K个大特征值对应的特征向量组成信号子空间M*K 噪声子空间M*(M-K)
2、先计算协方差矩阵R是90*90的，导向矢量本来长度是90的，但是为了去相干要进行空间平滑
对协方差矩阵进行空间平滑(牺牲阵列孔径去相干，导致协方差矩阵维度降低)
导向矢量的构建要和这个平滑后的协方差矩阵维度一致
得到了平滑后的协方差矩阵Rx(维度可能会降低，因为牺牲了阵列孔径来去相干)，进行矩阵分解
根据信源数目K(或从对角阵中得到K个大特征值)，进而确定噪声子空间(同时也得到了信号子空间)
从而进行谱函数的构造(需要用到导向矢量和噪声子空间)
协方差矩阵K个大特征值对应的特征矢量张成的信号空间和信号的导向矢量张成的信号空间是等价的
第二种平滑方式的导向矢量如何构建？

理论上信噪比大的时候，允许噪声子空间扩展到信号子空间，但是反过来不可以

对于3天线的数据进行线性拟合，是减去同一个tau呢，还是3天线的数据单独进行线性拟合呢？
为什么3天线的数据斜率不一样？
1、每一个CSI的值是特定频率下，时域展开的K次观测值的叠加，虽然每根天线都经历了相同的多径
但由于环境是时变的，每根天线经历的路径不完全一致，所以导致3天线的相位差不是恒定的
2、由于不同子载波频率不同导致，频率越大，3天线之间的相位差也越来越大
3、非线性的相位差，
因此最后导致3根天线相位斜率不一样
所以应该选择3天线单独进行线性拟合

相位变化：信号传播会导致信号相位的变化，信号相位会随着时间t的变化，处于一直变化的状态

经过处理后的CSI相位不再包含误差项α和β而仅仅是CSI真实相位的线性组合，CSI的处理后相位只与信道状态有关
因而可以用于区分不同的信道状态，监控信道变化
直接用网卡采集的数据的相位是2π折叠的状态，在[-π, π]的取值范围内，与真正的CSI测量相位相差2π整数倍
需要将其延拓位真实的值

时钟同步的主要目的是确定OFDM码元的开始位置，以便正确移除循环前缀，
提取出码元中用于FFT解调的部分，假设接收机的时钟同步偏移为n ∈ Z个采样
时钟同步误差对接收数据符号幅度的影响较小，但是其对数据符号的相位影响很大，且相
位误差与子载波号k时钟偏移n成正比

采样误差由两部分组成，第一部分是由于发射机和接收机采样时钟初始相位不一致造成的
这一部分同步误差与时钟同步误差具有相同的效果，唯一的区别是n此时的取值是[-1/2,+1/2)之间的小数
在后面的讨论中，我们将采样初始相位误差和时钟同步误差统称为时钟同步误差
第二部分是由于发射机和接收机的采样时钟频率不一致造成的

采样时钟同步的目的是接收端的采样时钟与发射端保持同频同相，采样时钟同步包括采样定时同步
和采样频率同步，采样定时同步是为了使接收端确定每个采样值符号的起始时刻
采样频率同步则是保证接收端和发射端具有相同的采样频率

CSI结构体得到的RSSI数据是DB形式

导向矩阵M*L、CSI矩阵方式以及OFDM的关系
	M个天线，L条多径形成的M*L的导向矩阵对所有的子载波都是一样的
	M*L CSI的理解方式就是CSI矩阵在特定子载波下的一列，就是CSI矩阵的一列
	对于CSI矩阵，每一行是不同天线的在不同子载波下的测量，由天线之间的距离引入相位差，
	每一列是不同子载波频率下的测量，(原因是OFDM技术，复调制信号分别调制在不同子载波上，
	一个OFDM码元数是多个已调子载波的叠加，可以看成是一束频率不同的信号同时传输，多个子载波信号同时传输
	，多个子载波经历相同的多径，只是5300网卡这种东西又可以把频率叠加信号重新分离开来)，
	由子载波之间的频率间隔引入相位差
	而每一列测量都是特定频率下，由L条路径测量值的叠加(M*L形式)，是时间上展开的L次测量的叠加
	CSI矩阵的每一个值，都是特定子载波频率下，特定天线时间上展开的L次测量的叠加，反映的是多径效应

	CSI矩阵的理解形式：一条路径在不同天线，不同子载波上的展开
	M*L导向矢量的理解形式：特定频率子载波下在不同天线，不同多径上的展开形式
	每一行代表特定天线不同多径下的测量，这个时候只是K次测量在时间上的展开，还未进行叠加
	每一列代表一条路径在不同天线上的测量，会有相位的差别
	
	每个天线上的测量都是K条多径的叠加(也就是每个天线接收的都是K条路径叠加之后的信号)，他的展开就是M*L的导向矩阵形式
	每一行角度都是不同的，代表同一个天线上的不同路径，每一列角度都是相同的，代表同一个路径的平面波到达不同的天线
	CSI矩阵的形式就是上述形式在不同子载波下的扩展
关于导向矩阵的行和列
	M*L的导向矩阵不同列代表不同的多径，不同列的角度不同，进行伪谱函数构造的时候，正是导向矩阵的列向量和噪声空间正交
	如果M > L 矩阵是列满秩矩阵，各列不相关，多条路径不相关
	如果M < L 矩阵是行满秩矩阵，各列就会出现相关的，各条多径就不能完全分辨
	这就是为什么阵元数目M要大于多径数目L
关于信号的协方差矩阵 Rxx
	M*L的CSI矩阵求其协方差矩阵是M*M，每一个元素Rxx(i, j)是第i根天线和第j根天线对应数据相乘求和
	这就是协方差矩阵的由来
	The best known algorithms are based on eigenstructure analysis of an M×M correlation 
	matrix Rxx in which the entry at the lth column and mth row is the MEAN CORRELATION between
	the lth and mth antennas’ signals.
空间平滑，求平均，去相干
	空间平滑就是将大的协方差矩阵，分成若干小的子阵，是各个子阵求和取平均的过程，这样就会导致矩阵维度降低
	去相干是以牺牲阵列孔径为代价的，导致新的矩阵维度的降低
	M 是阵元总数
	m 是子阵阵元数
	P 是平滑次数
	m = M - P + 1; 平滑次数增大，子阵有效阵元数目就会减小，会导致某些小的峰值的消失
	同时，AOA伪谱的整体噪声会降低，导致峰值更窄，准确度提升
	When the incoming signals are phase-synchronized(是相干信号) with each other 
	(as results from multipath) MUSIC perceives the distinct incoming signals as one 
	superposed signal, resulting in false peaks in P(θ) We therefore adopt spatial smoothing, 
	averaging incoming signals across NG groups of antennas to reduce this correlation

信号一个波长的传播长度，对应于相位的2π变化
不同列代表不同的多径，不同行代表不同的天线测量

M*L导向矢量的理解形式，每一列代表不同路径信号形成的平面波在不同天线上(天线阵列)上的测量，
在不同子载波层面进行扩展，就是CSI矩阵的理解形式，MUSIC算法解析多径，就是在特定频率下解析M*L导向矩阵不同的列，
只有M*L是列满秩矩阵，才能保证各列不相关，才能将所有多径解析出来(这就是为什么天线数目到大于多径数目)
考虑不同子载波下的不同多径信号，综合形成的矩阵维度是 CSI = M*N*L  M* : *L 就是某个特定子载波下的导向矩阵
M是天线维度， N是子载波维度， L是多径维度

where a(θi) is the array steering vector that characterizes added phase 
(relative to the first antenna) of each receiving component at the ith antenna

******************************************************************************************************************************************************************
1、箱图 filter之前分布范围很大，filter之后分布范围很小
cir峰值能量变化略有规律，不稳定，通过线性变换，线性拟合可以解决，使多个数据包的CIR峰值稳定
2、详细研究了AGC，AGC对同一个位置的不同的数据包变化很小(稳定环境下几乎不变化)，不同位置处AGC变化比较大(线性变化)
不同天线的Rssi_a、Rssi_b、Rssi_c是以db形式暴露的，使用包前导来计算的
(correspond to RSSI measured by the receiving NIC at the input to each antenna port)
为了得到接受信号强度，必须结合AGC，并减去常量魔数
3天线得到的Rssi_a、Rssi_b、Rssi_c是没有规律的，但是结合AGC就变得有规律了，且变化趋势和Total_RSS变化趋势一样